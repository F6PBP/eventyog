{% extends "ds/modal.html" %} 
{% block modal_body %}
<form
    id="ratingForm"
    method="POST"
    action="{% url 'yogevent:add_rating' event.uuid %}"
    class="w-full px-5 flex flex-col gap-4"
>   
    {% csrf_token %}
    <label for="rating">Rating:</label>
    <select
        name="rating"
        id="rating"
        class="w-fit"
    >
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
    </select>
    {% include "ds/textarea.html" with name="review" class="w-full min-h-[200px]" placeholder="Write your review here!" %}
</form>
<script>
    function submitRating() {
        const form = document.getElementById("ratingForm");
        const formData = new FormData(form);
        const messageDisplay = document.getElementById("averageRating");

        fetch(form.action, {
            method: form.method,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                // Update average rating
                if (messageDisplay) {
                    messageDisplay.textContent = `${data.data.average_rating}.0 / 5.0`;
                }
                
                // Close modal
                const modal = document.querySelector("#give-rating-modal");
                if (modal) {
                    modal.classList.add('hidden');
                }
                
                // Show success message
                if (typeof showToast === 'function') {
                    showToast('Rating submitted successfully!', 'success');
                } else {
                    alert(data.message);
                }
                
                // Reset form
                form.reset();
                
                // Optional: reload parts of the page that show ratings
                if (data.data.average_rating) {
                    const ratings = document.querySelectorAll('.rating-display');
                    ratings.forEach(rating => {
                        rating.textContent = data.data.average_rating;
                    });
                }
                
            } else {
                if (typeof showToast === 'function') {
                    showToast(data.error || 'Error submitting rating', 'error');
                } else {
                    alert(data.error || 'Error submitting rating');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (typeof showToast === 'function') {
                showToast('An error occurred. Please try again.', 'error');
            } else {
                alert('An error occurred. Please try again.');
            }
        });
    }
</script>
{% endblock modal_body %}
